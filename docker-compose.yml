version: "3.8"
services:
        mica:
                image: obiba/mica
                ports:
                        - "8882:8082"
                depends_on:
                        es8:
                                condition: service_healthy
                        mongo:
                                condition: service_healthy
                environment:
                        - JAVA_OPTS=-Xmx2G
                        - MICA_ADMINISTRATOR_PASSWORD=password
                        - MICA_ANONYMOUS_PASSWORD=password
                        - MONGO_HOST=mongo
                        - MONGO_PORT=27017
                        - MONGO_DB=mica
                        - MONGO_USER=${MONGO_USER:-obiba}
                        - MONGO_PASSWORD=${MONGO_PASSWORD:-password}
                        - OPAL_URL=http://opal:8080
                        - AGATE_URL=http://agate:8081
                        - ELASTICSEARCH_HOST=es8
                volumes:
                        - /tmp/mica:/srv
                links: # Legacy
                        - mongo
                        - es8
        mongo:
                image: mongo:6.0
                environment:
                        - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER:-obiba}
                        - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-password}
                healthcheck:
                        test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok"]
                        interval: 5m
                        timeout: 30s
                        retries: 3
                        start_period: 60s
        opal:
                image: obiba/opal
                ports:
                        - "8880:8080"
                depends_on:
                        mongo:
                                condition: service_healthy
                environment:
                        - OPAL_ADMINISTRATOR_PASSWORD=password
                        - MONGO_HOST=mongo
                        - MONGO_PORT=27017
                        - MONGO_USER=${MONGO_USER:-obiba}
                        - MONGO_PASSWORD=${MONGO_PASSWORD:-password}
                        - MONGODATA_DATABASE=opal
                        - AGATE_URL=http://agate:8081
                        - ROCK_HOSTS=rock:8085
                volumes:
                        - /tmp/opal:/srv
                links: # Keeping links for legacy reasons, but depends_on is preferred
                        - mongo

        agate:
                image: obiba/agate
                ports:
                        - "8881:8081"
                depends_on:
                        mongo:
                                condition: service_healthy
                environment:
                        - AGATE_ADMINISTRATOR_PASSWORD=password
                        - MONGO_HOST=mongo
                        - MONGO_PORT=27017
                        - MONGO_DB=agate
                        - MONGO_USER=${MONGO_USER:-obiba}
                        - MONGO_PASSWORD=${MONGO_PASSWORD:-password}
                        - RECAPTCHA_SITE_KEY=6Lfo7gYTAAAAAOyl8_MHuH-AVBzRDtpIuJrjL3Pb
                        - RECAPTCHA_SECRET_KEY=6Lfo7gYTAAAAADym-vSDvPBeBCXaxIprA0QXLk_b
                volumes:
                        - /tmp/agate:/srv
                links: # Keeping links for legacy reasons, but depends_on is preferred
                        - mongo
        rock:
                image: obiba/rock
        es8:
                image: docker.elastic.co/elasticsearch/elasticsearch:8.16.1
                expose:
                        - 9200
                        - 9300
                environment:
                        - cluster.name=mica
                        - node.name=es8
                        - discovery.type=single-node
                        - bootstrap.memory_lock=true
                        - network.host=0.0.0.0
                        - xpack.security.enabled=false
                        - xpack.security.http.ssl.enabled=false
                        - ES_JAVA_OPTS=-Xms512m -Xmx512m
                ulimits:
                        memlock:
                                soft: -1
                                hard: -1
                healthcheck:
                        test: ["CMD-SHELL", "curl -s -f http://localhost:9200/_cluster/health || exit 1"]
                        interval: 5m
                        timeout: 30s
                        retries: 3
                        start_period: 60s
